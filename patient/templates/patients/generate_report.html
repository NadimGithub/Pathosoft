<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Test Report</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; font-size: 13px; font-family: Arial; }
    .header { background-color: #28a745; color: white; padding: 10px 15px; border-radius: 5px 5px 0 0; font-weight: bold; }
    .section-box { background: white; padding: 15px; border-radius: 0 0 5px 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
    .group-row { background-color: #e2f3e4; font-weight: bold; text-align: left; }
    .btn-custom { border-radius: 15px; padding: 3px 12px; font-size: 13px; }
    .highlight-low {
  background-color: #e45964 !important;    
}

  </style>
</head>
<body>
<div class="container mt-4">
  <div class="header">TEST REPORT</div>

  <div class="section-box">
    <div class="row mb-2">
      <div class="col-md-2"><b>Date:</b> {{ patient.sample_date }}</div>
      <div class="col-md-2"><b>Lab No:</b> {{ patient.patient_id }}</div>
      <div class="col-md-2"><b>Title:</b> {{ patient.title }}</div>
      <div class="col-md-3"><b>Patient Name:</b> {{ patient.patient_name }}</div>
      <div class="col-md-3"><b>Mobile:</b> {{ patient.mobile_number }}</div>
    </div>
    <div class="row">
      <div class="col-md-2"><b>Age:</b> {{ patient.age }}</div>
      <div class="col-md-2"><b>Gender:</b> {{ patient.gender }}</div>
      <div class="col-md-3"><b>Doctor:</b> {{ patient.doctor.doctor_name }}</div>
    </div>
  </div>

  <form method="POST">
    {% csrf_token %}
    <div class="section-box">
      <table class="table table-bordered table-sm">
        <thead>
          <tr>
            <th>S.No</th>
            <th>Test</th>
            <th>Result</th>
            <th>Units</th>
            <th>Normal Range</th>
            <th>Notes</th>
            <th>Remarks</th>
          </tr>
        </thead>
      <tbody>
        {% for group, tests in grouped_tests.items %}
        <tr class="group-row">
        <td colspan="7">{{ group }}</td>
        </tr>

        {% for t in tests %}
        <tr class="test-row" >
        <td>{{ forloop.counter }}</td>
        <td>{{ t.test.test_name }}</td>
        <td>
            <input type="number" step="any" 
                name="result_{{ t.id }}" 
                value="{{ t.result_value|default_if_none:'' }}" 
                class="form-control form-control-sm result-input"
                data-lower="{{ t.test.lower_range|default_if_none:'' }}" 
                data-upper="{{ t.test.upper_range|default_if_none:'' }}" >
        </td>
        <td>{{ t.test.units }}</td>
        <td>
            {% if t.test.lower_range or t.test.upper_range %}
            {{ t.test.lower_range|default:"" }} â€“ {{ t.test.upper_range|default:"" }}
            {% else %}
            {{ t.test.normal_range|default:"-" }}
            {% endif %}
        </td>
        <td><input type="text" name="notes_{{ t.id }}" value="{{ t.notes|default_if_none:'' }}" class="form-control form-control-sm"></td>
        <td><input type="text" name="remarks_{{ t.id }}" value="{{ t.remarks|default_if_none:'' }}" class="form-control form-control-sm"></td>
        </tr>
        {% endfor %}
        {% endfor %}
    </tbody>

      </table>
    </div>

    <div class="section-box d-flex justify-content-between align-items-center">
      <div>
        <b>Basic Amt:</b> {{ patient.basic_amount }} |
        <b>Discount:</b> {{ patient.discount }} |
        <b>Net:</b> {{ patient.total_amount }} |
        <b>Paid:</b> {{ patient.paid_amount }} |
        <b>Balance:</b> {{ patient.balance_amount }}
      </div>
      <div>
        <button type="submit" class="btn btn-success btn-sm btn-custom">Update</button>
        <a href="{% url 'print_test_report' patient.patient_id %}" target="_blank" 
          class="btn btn-primary btn-sm btn-custom">
          Print
        </a>
        <a href="{% url 'view_patients' %}" class="btn btn-secondary btn-sm btn-custom">Close</a>
      </div>
    </div>
  </form>
</div>

<script>
(function() {
  function parseNumber(val) {
    if (val === null || val === undefined) return NaN;
    val = String(val).replace(/,/g, '').trim();
    if (val === '') return NaN;
    return Number(val);
  }

  function checkRangeForInput(input) {
    if (!input) return;
    const td = input.closest('td');
    if (!td) return;

    const value = parseNumber(input.value);
    const lower = parseNumber(input.getAttribute('data-lower'));
    const upper = parseNumber(input.getAttribute('data-upper'));

    // Remove previous highlight
    td.classList.remove('highlight-low');

    // Skip check if no numeric value
    if (isNaN(value)) return;

    const hasLower = !isNaN(lower);
    const hasUpper = !isNaN(upper);

    // Highlight only the td if value is out of range
    if ((hasLower && value < lower) || (hasUpper && value > upper)) {
      td.classList.add('highlight-low');
    }
  }

  // Check when user leaves input
  document.addEventListener('focusout', function(e) {
    const el = e.target;
    if (el.classList && el.classList.contains('result-input')) {
      setTimeout(() => checkRangeForInput(el), 0);
    }
  }, true);

  // Check on value change
  document.addEventListener('change', function(e) {
    const el = e.target;
    if (el.classList && el.classList.contains('result-input')) {
      checkRangeForInput(el);
    }
  }, true);

  // Check on Enter key
  document.addEventListener('keydown', function(e) {
    const el = e.target;
    if (!(el.classList && el.classList.contains('result-input'))) return;
    if (e.key === 'Enter') {
      e.preventDefault();
      checkRangeForInput(el);
      const all = Array.from(document.querySelectorAll('.result-input'));
      const idx = all.indexOf(el);
      if (idx !== -1 && idx + 1 < all.length) {
        all[idx + 1].focus();
        if (typeof all[idx + 1].select === 'function') all[idx + 1].select();
      }
    }
  });

  // Initial check for prefilled inputs
  document.addEventListener('DOMContentLoaded', function() {
    const all = document.querySelectorAll('.result-input');
    all.forEach(inp => checkRangeForInput(inp));
  });
})();
</script>


</body>
</html>
