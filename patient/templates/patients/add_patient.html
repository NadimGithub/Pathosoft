{% extends 'base.html' %} {% load static %} {% block title %}Patient Entry{% endblock %} {% block content %}
<link rel="stylesheet" href="{% static 'css/form-style.css' %}">
<div class="container-fluid my-5 d-flex justify-content-center">
    <div class="card shadow-lg border-0 rounded-4 w-90">
        <div class="card-header d-flex align-items-center justify-content-between rounded-top-4">
            <h4 class="mb-0 text-white"> <i class="fa-solid fa-user-plus me-2"></i> Patient Entry </h4>
            <a href="{% url 'view_patients' %}" class="btn btn-light btn-sm fw-semibold rounded-pill px-3 hover-glow"> <i class="fa-solid fa-arrow-left me-1"></i> Back </a>
        </div>
        <div class="card-body p-4">
            <form method="POST"> {% csrf_token %}
                <!-- Patient Info Row -->
                <div class="row g-4 mb-3">
                    <div class="col-md-3"> <label class="form-label fw-semibold">Title</label> <input type="text" name="title" class="form-control shadow-sm"> </div>
                    <div class="col-md-3"> <label class="form-label fw-semibold">Patient Name</label> <input type="text" name="patient_name" class="form-control shadow-sm" required> </div>
                    <div class="col-md-2"> <label class="form-label fw-semibold">Gender</label> <select name="gender" class="form-select custom-dropdown"> <option>Male</option> <option>Female</option> <option>Other</option> </select> </div>
                    <div class="col-md-2"> <label class="form-label fw-semibold">Age</label> <input type="number" name="age" class="form-control shadow-sm"> </div>
                    <div class="col-md-2"> <label class="form-label fw-semibold">Mobile No</label> <input type="text" name="mobile_number" class="form-control shadow-sm"> </div>
                </div>
                <!-- Doctor and Date Row -->
                <div class="row g-4 mb-3">
                    <div class="col-md-4"> <label class="form-label fw-semibold">Doctor</label> <select name="doctor" class="form-select custom-dropdown"> {% for d in doctors %} <option value="{{ d.id }}">{{ d.doctor_name }}</option> {% endfor %} </select> </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Sample Date</label> <input type="date" name="sample_date" class="form-control shadow-sm"> </div>
                    <div class="col-md-3"> <label class="form-label fw-semibold">Reporting Date</label> <input type="date" name="reporting_date" class="form-control shadow-sm"> </div>
                    <div class="col-md-2"> <label class="form-label fw-semibold">Weight</label> <input type="number" step="0.01" name="weight" class="form-control shadow-sm"> </div>
                </div>
                <!-- Tests and Billing -->
                <div class="row">
                    <div class="col-md-3">
                        <div class="bg-light p-3 rounded shadow-sm">
                            <h6 class="text-primary fw-bold mb-2">Test Group List</h6> <input type="text" id="searchGroup" class="form-control mb-2" placeholder="Search group...">
                            <table class="table table-bordered table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>Group Name</th>
                                        <th>Select</th>
                                    </tr>
                                </thead>
                                <tbody id="groupTable"> {% for g in groups %}
                                    <tr>
                                        <td>{{ g.group_name }}</td>
                                        <td><input type="checkbox" class="group-check" data-id="{{ g.id }}"></td>
                                    </tr> {% endfor %} </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="bg-light p-3 rounded shadow-sm mb-3">
                            <h6 class="text-primary fw-bold mb-2">Choose Tests</h6>
                            <table class="table table-bordered table-sm">
                                <thead>
                                    <tr>
                                        <th>Select</th>
                                        <th>Test Name</th>
                                        <th>Normal Range</th>
                                        <th>Units</th>
                                        <th>Cost (₹)</th>
                                    </tr>
                                </thead>
                                <tbody id="testTable"></tbody>
                            </table>
                        </div>
                        <div class="bg-light p-3 rounded shadow-sm mb-3">
                            <h6 class="text-primary fw-bold mb-2">Final List of Selected Tests</h6>
                            <table class="table table-bordered table-sm">
                                <thead>
                                    <tr>
                                        <th>Test Name</th>
                                        <th>Normal Range</th>
                                        <th>Units</th>
                                        <th>Cost (₹)</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="finalTable"></tbody>
                            </table>
                        </div>
                        <div class="bg-light p-3 rounded shadow-sm mb-3">
                            <h6 class="text-primary fw-bold mb-2">Billing Details</h6>
                            <div class="row g-3">
                                <div class="col-md-2"> <label>Basic Amount</label> <input type="text" id="basic_amount" name="basic_amount" readonly class="form-control shadow-sm" value="0"> </div>
                                <div class="col-md-2"> <label>Extra Cost</label> <input type="number" id="extra_cost" name="extra_cost" class="form-control shadow-sm" value="0"> </div>
                                <div class="col-md-2"> <label>Discount</label> <input type="number" id="discount" name="discount" class="form-control shadow-sm" value="0"> </div>
                                <div class="col-md-2"> <label>Total Amount</label> <input type="text" id="total_amount" name="total_amount" readonly class="form-control shadow-sm" value="0"> </div>
                                <div class="col-md-2"> <label>Paid Amount</label> <input type="number" id="paid_amount" name="paid_amount" class="form-control shadow-sm" value="0"> </div>
                                <div class="col-md-2"> <label>Balance</label> <input type="text" id="balance_amount" name="balance_amount" readonly class="form-control shadow-sm" value="0"> </div>
                            </div>
                        </div>
                        <div class="text-center mt-4"> <button type="submit" class="btn btn-primary me-2 px-4 py-2"> <i class="fa-solid fa-save me-1"></i> Save </button> {% if patient %}
                            <a href="{% url 'print_receipt' patient.patient_id %}" target="_blank" class="btn btn-success me-2 px-4 py-2">
                                <i class="fa-solid fa-print me-1"></i> Print </a> {% else %} <button type="button" class="btn btn-success me-2 px-4 py-2" disabled>Print</button> {% endif %} <a href="{% url 'add_patient' %}" class="btn btn-warning me-2 px-4 py-2">Clear</a>                            <a href="{% url 'view_patients' %}" class="btn btn-danger px-4 py-2">Cancel</a> </div> {% if message %}
                        <div class="alert alert-success mt-3">{{ message }}</div> {% endif %} </div>
                </div> <input type="hidden" name="tests" id="selected_tests_input"> </form>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let selectedTests = [];
    let basicAmount = 0;

    // Load tests by group
    $(document).on("change", ".group-check", function() {
        let groupId = $(this).data("id");
        if (this.checked) {
            $.get(`/patient/get-tests/${groupId}/`, function(tests) {
                tests.forEach(test => {
                    $("#testTable").append(`
          <tr id="test-row-${test.test_id}">
            <td><input type="checkbox" class="test-check"
                       data-id="${test.test_id}"
                       data-name="${test.test_name}"
                       data-range="${test.normal_range || '-'}"
                       data-units="${test.units || '-'}"
                       data-cost="${test.cost || 0}"></td>
            <td>${test.test_name}</td>
             <td>${test.normal_range || '-'}</td>
            <td>${test.units || '-'}</td>
            <td>${test.cost || 0}</td>
          </tr>
        `);
                });
            });
        } else {
            $("#testTable").empty();
        }
    });

    // Select test
    $(document).on("change", ".test-check", function() {
        let id = $(this).data("id");
        let name = $(this).data("name");
        let range = $(this).data("range");
        let units = $(this).data("units");
        let cost = parseFloat($(this).data("cost") || 0);

        if (this.checked) {
            selectedTests.push(id);
            $("#finalTable").append(`
      <tr id="final-${id}">
        <td>${name}</td><td>${range}</td><td>${units}</td><td>${cost}</td>
        <td><button type="button" class="btn btn-sm btn-danger del-row" data-id="${id}" data-cost="${cost}">X</button></td>
      </tr>
    `);
            basicAmount += cost;
        } else {
            $(`#final-${id}`).remove();
            selectedTests = selectedTests.filter(x => x !== id);
            basicAmount -= cost;
        }
        updateTotals();
    });

    // Delete row
    $(document).on("click", ".del-row", function() {
        let id = $(this).data("id");
        let cost = parseFloat($(this).data("cost"));
        $(`#final-${id}`).remove();
        $(`#test-row-${id} .test-check`).prop("checked", false);
        selectedTests = selectedTests.filter(x => x !== id);
        basicAmount -= cost;
        updateTotals();
    });

    function updateTotals() {
        $("#basic_amount").val(basicAmount.toFixed(2));
        let extra = parseFloat($("#extra_cost").val()) || 0;
        let disc = parseFloat($("#discount").val()) || 0;
        let total = basicAmount + extra - disc;
        $("#total_amount").val(total.toFixed(2));

        let paid = parseFloat($("#paid_amount").val()) || 0;
        let bal = total - paid;
        $("#balance_amount").val(bal.toFixed(2));

        $("#selected_tests_input").val(selectedTests.join(","));
    }

    // Update totals when extra, discount or paid changes
    $("#extra_cost, #discount, #paid_amount").on("input", updateTotals);


    $("#printBtn").click(function() {
        const patientId = $("#patient_id").val(); // if you already have id in form
        if (patientId) {
            window.open(`/patient/receipt/${patientId}/`, "_blank");
        } else {
            alert("Please save patient first before printing!");
        }
    });
</script>
{% endblock %}