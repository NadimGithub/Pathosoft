{% extends 'base.html' %} {% load static %} {% block title %}Edit Patient{% endblock %} {% block content %}

<link rel="stylesheet" href="{% static 'css/form-style.css' %}">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<div class="container-fluid my-5 d-flex justify-content-center">
    <div class="card shadow-lg border-0 rounded-4 w-90">
        <!-- Header -->
        <div class="card-header d-flex align-items-center justify-content-between rounded-top-4">
            <h4 class="mb-0 text-white">
                <i class="fa-solid fa-user-pen me-2"></i> Edit Patient
            </h4>
            <a href="{% url 'view_patients' %}" class="btn btn-light btn-sm fw-semibold rounded-pill px-3 hover-glow">
                <i class="fa-solid fa-arrow-left me-1"></i> Back
            </a>
        </div>

        <div class="card-body p-4">
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="patient_id" value="{{ patient.patient_id }}">

                <!-- Patient Info Row -->
                <div class="row g-4 mb-3">
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Title</label>
                        <input type="text" name="title" class="form-control shadow-sm" value="{{ patient.title }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Patient Name</label>
                        <input type="text" name="patient_name" class="form-control shadow-sm" required value="{{ patient.patient_name }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-semibold">Gender</label>
                        <select name="gender" class="form-select custom-dropdown">
                        <option value="Male" {% if patient.gender == 'Male' %}selected{% endif %}>Male</option>
                        <option value="Female" {% if patient.gender == 'Female' %}selected{% endif %}>Female</option>
                        <option value="Other" {% if patient.gender == 'Other' %}selected{% endif %}>Other</option>
                    </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-semibold">Age</label>
                        <input type="number" name="age" class="form-control shadow-sm" value="{{ patient.age }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-semibold">Mobile No</label>
                        <input type="text" name="mobile_number" class="form-control shadow-sm" value="{{ patient.mobile_number }}">
                    </div>
                </div>

                <!-- Doctor and Date Row -->
                <div class="row g-4 mb-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Doctor</label>
                        <select name="doctor" class="form-select custom-dropdown">
                        {% for d in doctors %}
                        <option value="{{ d.id }}" {% if patient.doctor.id == d.id %}selected{% endif %}>{{ d.doctor_name }}</option>
                        {% endfor %}
                    </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Sample Date</label>
                        <input type="date" name="sample_date" class="form-control shadow-sm" value="{{ patient.sample_date|date:'Y-m-d' }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Reporting Date</label>
                        <input type="date" name="reporting_date" class="form-control shadow-sm" value="{{ patient.reporting_date|date:'Y-m-d' }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-semibold">Weight</label>
                        <input type="number" step="0.01" name="weight" class="form-control shadow-sm" value="{{ patient.weight }}">
                    </div>
                </div>

                <!-- Tests and Billing -->
                <div class="row">
                    <!-- Test Group List -->
                    <div class="col-md-3">
                        <div class="bg-light p-3 rounded shadow-sm">
                            <h6 class="text-primary fw-bold mb-2">Test Group List</h6>
                            <input type="text" id="searchGroup" class="form-control mb-2" placeholder="Search group...">
                            <table class="table table-bordered table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>Group Name</th>
                                        <th>Select</th>
                                    </tr>
                                </thead>
                                <tbody id="groupTable">
                                    {% for g in groups %}
                                    <tr>
                                        <td>{{ g.group_name }}</td>
                                        <td>
                                            <input type="checkbox" class="group-check" data-id="{{ g.id }}" {% if g.id in selected_group_ids %}checked{% endif %}>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Test & Billing Section -->
                    <div class="col-md-9">
                        <!-- Choose Tests -->
                        <div class="bg-light p-3 rounded shadow-sm mb-3">
                            <h6 class="text-primary fw-bold mb-2">Choose Tests</h6>
                            <table class="table table-bordered table-sm">
                                <thead>
                                    <tr>
                                        <th>Select</th>
                                        <th>Test Name</th>
                                        <th>Normal Range</th>
                                        <th>Units</th>
                                        <th>Cost (₹)</th>
                                    </tr>
                                </thead>
                                <tbody id="testTable">
                                    {% for test in tests %}
                                    <tr id="test-row-{{ test.test_id }}">
                                        <td><input {% if test.test_id in selected_test_ids %}checked{% endif %} type="checkbox" class="test-check" data-id="{{ test.test_id }}" data-name="{{ test.test_name }}" data-range="{{ test.normal_range }}" data-units="{{ test.units }}"
                                                data-cost="{{ test.cost }}"></td>
                                        <td>{{ test.test_name }}</td>
                                        <td>{{ test.lower_range}}-{{ test.upper_range }}</td>
                                        <td>{{ test.units }}</td>
                                        <td>{{ test.cost }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Final Selected Tests -->
                        <div class="bg-light p-3 rounded shadow-sm mb-3">
                            <h6 class="text-primary fw-bold mb-2">Final List of Selected Tests</h6>
                            <table class="table table-bordered table-sm">
                                <thead>
                                    <tr>
                                        <th>Test Name</th>
                                        <th>Normal Range</th>
                                        <th>Units</th>
                                        <th>Cost (₹)</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="finalTable">
                                    {% for t in selected_tests %}
                                    <tr id="final-{{ t.test.test_id }}">
                                        <td>{{ t.test.test_name }}</td>
                                        <td>{{ t.test.lower_range }}-{{ t.test.upper_range }}</td>
                                        <td>{{ t.test.units }}</td>
                                        <td>{{ t.test.cost }}</td>
                                        <td><button type="button" class="btn btn-sm btn-danger del-row" data-id="{{ t.test.test_id }}" data-cost="{{ t.test.cost }}">X</button></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Billing Details -->
                        <div class="bg-light p-3 rounded shadow-sm mb-3">
                            <h6 class="text-primary fw-bold mb-2">Billing Details</h6>
                            <div class="row g-3">
                                <div class="col-md-2"><label>Basic Amount</label><input type="text" id="basic_amount" name="basic_amount" readonly class="form-control shadow-sm" value="{{ patient.basic_amount }}"></div>
                                <div class="col-md-2"><label>Extra Cost</label><input type="number" id="extra_cost" name="extra_cost" class="form-control shadow-sm" value="{{ patient.extra_cost }}"></div>
                                <div class="col-md-2"><label>Discount</label><input type="number" id="discount" name="discount" class="form-control shadow-sm" value="{{ patient.discount }}"></div>
                                <div class="col-md-2"><label>Total Amount</label><input type="text" id="total_amount" name="total_amount" readonly class="form-control shadow-sm" value="{{ patient.total_amount }}"></div>
                                <div class="col-md-2"><label>Paid Amount</label><input type="number" id="paid_amount" name="paid_amount" class="form-control shadow-sm" value="{{ patient.paid_amount }}"></div>
                                <div class="col-md-2"><label>Balance</label><input type="text" id="balance_amount" name="balance_amount" readonly class="form-control shadow-sm" value="{{ patient.balance_amount }}"></div>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary me-2 px-4 py-2">
                            <i class="fa-solid fa-rotate me-1"></i> Update
                        </button>
                            <a href="{% url 'print_receipt' patient.patient_id %}" target="_blank" class="btn btn-success me-2 px-4 py-2">
                                <i class="fa-solid fa-print me-1"></i> Print
                            </a>
                            <a href="{% url 'view_patients' %}" class="btn btn-danger px-4 py-2">Cancel</a>
                        </div>

                        {% if message %}
                        <div class="alert alert-success mt-3">{{ message }}</div>
                        {% endif %}
                    </div>
                </div>

                <input type="hidden" name="tests" id="selected_tests_input" value="{{ selected_test_ids|join:',' }}">
            </form>
        </div>
    </div>

</div>
<script>
    let selectedTests = "{{ selected_test_ids|join:',' }}".split(',').filter(Boolean).map(Number);
    let basicAmount = parseFloat($("#basic_amount").val()) || 0;

    // Load tests by group
    $(document).on("change", ".group-check", function() {
        let groupId = $(this).data("id");
        if (this.checked) {
            $.get(`/patient/get-tests/${groupId}/`, function(tests) {
                tests.forEach(test => {
                    $("#testTable").append(`
          <tr id="test-row-${test.test_id}">
            <td><input type="checkbox" class="test-check"
                       data-id="${test.test_id}"
                       data-name="${test.test_name}"
                       data-range="${test.normal_range || '-'}"
                       data-units="${test.units || '-'}"
                       data-cost="${test.cost || 0}"></td>
            <td>${test.test_name}</td>
            <td>${test.normal_range || '-'}</td>
            <td>${test.units || '-'}</td>
            <td>${test.cost || 0}</td>
          </tr>
        `);
                });
            });
        } else {
            $("#testTable").empty();
        }
    });

    // Select test
    $(document).on("change", ".test-check", function() {
        let id = $(this).data("id");
        let name = $(this).data("name");
        let range = $(this).data("range");
        let units = $(this).data("units");
        let cost = parseFloat($(this).data("cost") || 0);

        if (this.checked) {
            selectedTests.push(id);
            $("#finalTable").append(`
      <tr id="final-${id}">
        <td>${name}</td><td>${range}</td><td>${units}</td><td>${cost}</td>
        <td><button type="button" class="btn btn-sm btn-danger del-row" data-id="${id}" data-cost="${cost}">X</button></td>
      </tr>
    `);
            basicAmount += cost;
        } else {
            $(`#final-${id}`).remove();
            selectedTests = selectedTests.filter(x => x !== id);
            basicAmount -= cost;
        }
        updateTotals();
    });

    // Delete row
    $(document).on("click", ".del-row", function() {
        let id = $(this).data("id");
        let cost = parseFloat($(this).data("cost"));
        $(`#final-${id}`).remove();
        $(`#test-row-${id} .test-check`).prop("checked", false);
        selectedTests = selectedTests.filter(x => x !== id);
        basicAmount -= cost;
        updateTotals();
    });

    function updateTotals() {
        $("#basic_amount").val(basicAmount.toFixed(2));
        let extra = parseFloat($("#extra_cost").val()) || 0;
        let disc = parseFloat($("#discount").val()) || 0;
        let total = basicAmount + extra - disc;
        $("#total_amount").val(total.toFixed(2));

        let paid = parseFloat($("#paid_amount").val()) || 0;
        let bal = total - paid;
        $("#balance_amount").val(bal.toFixed(2));

        $("#selected_tests_input").val(selectedTests.join(","));
    }

    $("#extra_cost, #discount, #paid_amount").on("input", updateTotals);
</script>
{% endblock %}